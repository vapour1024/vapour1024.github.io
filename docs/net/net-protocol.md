# 网络协议学习笔记

---

# ch01 为什么要学习网络协议

## 协议三要素

计算机语言作为程序员控制一台计算机工作的协议，具备了协议的三要素。

- 语法，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
  
- 语义，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
  
- 顺序，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。
  

## 我们常用的网络协议有哪些？

以访问一个网站为例

1. 获取网站域名对应的IP地址，使用DNS/HTTPDNS
  
2. 浏览器开始打包请求，使用HTTP/HTTPS
  
3. TCP（面向连接，网站应用端口、浏览器端口）/UDP（无连接）
  
4. IP（客户端IP、服务端IP）
  
5. DHCP（IP及默认网关配置）/ARP（IP到MAC的映射）
  
6. 路由协议，使用OSPF和BGP
  
7. 进程间通信，使用RPC
  

| 层级  | 协议  |
| --- | --- |
| 应用层 | DHCP HTTP HTTPS RTMP P2P GTP RPC |
| 传输层 | UDP TCP SCTP |
| 网络层 | ICMP IP OSPF BGP IPSex GRE |
| 链路层 | ARP VLAN STP |

## 思考题

1. 当网络包到达一个网关的时候，可以通过路由表得到下一个网关的 IP 地址，直接通过 IP 地址找就可以了，为什么还要通过本地的 MAC 地址呢？
  
  因为还是需要知道MAC地址来进行链路层的数据传输，仅仅知道IP是不够的的
  

[全面理解DNS及HTTPDNS - 掘金 (juejin.cn)](https://juejin.cn/post/6844903987796246542)

---

# ch02 网络分层的真实含义是什么？

## 网络为什么要分层？

因为复杂的程序都要分层。

理解计算机网络中的概念，一个很好的角度是，想象网络包就是一段 Buffer，或者一块内存，是有格式的。

同时，想象自己是一个处理网络包的程序，而且这个程序可以跑在电脑上，可以跑在服务器上，可以跑在交换机上，也可以跑在路由器上。你想象自己有很多的网口，从某个口拿进一个网络包来，用自己的程序处理一下，再从另一个网口发送出去。

## 揭秘层与层之间的关系

那 TCP 在三次握手的时候，IP 层和 MAC 层在做什么呢？当然是 TCP 发送每一个消息，都会带着 IP 层和 MAC 层了。因为，TCP 每发送一个消息，IP 层和 MAC 层的所有机制都要运行一遍。而你只看到 TCP 三次握手了，其实，IP 层和 MAC 层为此也忙活好久了。

这里要记住一点：

只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。

## 小结

1. 始终想象自己是一个处理网络包的程序：如何拿到网络包，如何根据规则进行处理，如何发出去
2. 始终牢记一个原则：只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。

## 思考题

1. 要想学习网络协议，IP 这个概念是最最基本的，那你知道如何查看 IP 地址吗？
  
  windows查看ip地址的命令：ipconfig linux查看ip地址的命令：ifconfig 或者 ip addr 。
  

---

# ch03 ifconfig

## 查看 IP 地址

- `ifconfig` net-tools
  
- `ip addr` iproute2
  

```shell
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:92:a6:b9 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.188/24 brd 192.168.56.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::8c4c:b644:d253:9fa8/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```

IPV4：32bit

IPV4：128bit

IP地址分类：ABCDE

## 无类型域间选路（CIDR）

这种方式打破了原来设计的几类地址的做法，将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。从哪里分呢？你如果注意观察的话可以看到，10.100.122.2/24，这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR。后面 24 的意思是，32 位中，前 24 位是网络号，后 8 位是主机号。

伴随着 CIDR 存在的，一个是广播地址，10.100.122.255。如果发送这个地址，所有 10.100.122 网络里面的机器都可以收到。另一个是子网掩码，255.255.255.0。

将子网掩码和 IP 地址进行 AND 计算（按位计算 AND），就可得到网络号。

## 公有 IP 地址和私有 IP 地址

- 私有 IP 地址
  
  平时我们看到的数据中心里，办公室、家里或学校的 IP 地址，一般都是私有 IP 地址段。因为这些地址允许组织内部的 IT 人员自己管理、自己分配，而且可以重复。因此，你学校的某个私有 IP 地址段和我学校的可以是一样的。
  
- 公有 IP 地址。
  
  公有 IP 地址有个组织统一分配，你需要去买。如果你搭建一个网站，给你学校的人使用，让你们学校的 IT 人员给你一个 IP 地址就行。但是假如你要做一个类似网易 163 这样的网站，就需要有公有 IP 地址，这样全世界的人才能访问。
  

例如Wi-Fi 路由器的地址是 192.168.0.1，而 192.168.0.255 就是广播地址。一旦发送这个地址，整个 192.168.0 网络里面的所有机器都能收到。

在 IP 地址的后面有个 scope，global说明这张网卡是可以对外的，可以接收来自各个地方的包。host说明这张网卡仅仅可以供本机相互通信。

lo 全称是 loopback，又称环回接口，往往会被分配到 127.0.0.1 这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。

## MAC 地址

MAC 地址是一个网卡的物理地址，用十六进制，6 个 byte 表示。

MAC 地址号称全局唯一，不会有两个网卡有相同的 MAC 地址，而且网卡自生产出来，就带着这个地址。

一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能。而定位功能需要IP地址

MAC 地址更像是身份证，是一个唯一的标识

MAC 地址是有一定定位功能的，只不过局限在一个子网里面

## 网络设备的状态标识

`enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000`

- UP 表示网卡处于启动的状态
  
- BROADCAST 表示这个网卡有广播地址，可以发送广播包
  
- MULTICAST 表示网卡可以发送多播包
  
- LOWER_UP 表示物理连接正常（网线插着）
  
- MTU1500 表示以太网最大传输单元 MTU 为 1500
  
- qdisc pfifo_fast
  
  qdisc 全称是 queueing discipline，中文叫排队规则。内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的 qdisc（排队规则）把数据包加入队列。
  
  - pfifo：不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列
    
  - pfifo_fast：它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则。三个波段（band）的优先级也不相同。band 0 的优先级最高，band 2 的最低。如果 band 0 里面有数据包，系统就不会处理 band 1 里面的数据包。
    
    数据包是按照服务类型（Type of Service，TOS）被分配到三个波段（band）里面的。TOS 是 IP 头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。
    

## 小结

1. IP 是地址，有定位功能
  
2. MAC 是身份证，无定位功能
  
3. CIDR 可以用来判断是不是本地人
  
4. IP 分公有的 IP 和私有的 IP
  

## 思考题

1. 你知道 net-tools 和 iproute2 的“历史”故事吗？
  
  net-tools起源于BSD，自2001年起，Linux社区已经对其停止维护，而iproute2旨在取代net-tools，并提供了一些新功能。一些Linux发行版已经停止支持net-tools，只支持iproute2。
  net-tools通过procfs(/proc)和ioctl系统调用去访问和改变内核网络配置，而iproute2则通过netlink套接字接口与内核通讯。
  net-tools中工具的名字比较杂乱，而iproute2则相对整齐和直观，基本是ip命令加后面的子命令。
  虽然取代意图很明显，但是这么多年过去了，net-tool依然还在被广泛使用。
  
2. 这一节讲的是如何查看 IP 地址，那你知道 IP 地址是怎么来的吗？
  
  DHCP分配
  

---

# ch04 DHCP与PXE：IP是怎么来的，又是怎么没的？

## 如何配置 IP 地址？

使用 net-tools

```shell
sudo ifconfig eth1 10.0.0.1/24
sudo ifconfig eth1 up
```

使用 iproute2：

```shell
sudo ip addr add 10.0.0.1/24 dev eth1
sudo ip link set up eth1
```

## 动态主机配置协议（DHCP）

只需要管理员配置一段共享的 IP 地址。每一台新接入的机器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配置好。使用完了还回去，其他的机器也能用。

### DHCP 的工作方式

1. DHCP discover
  
  新来的机器使用 IP 地址 0.0.0.0 发送了一个广播包，目的 IP 地址为 255.255.255.255。广播包封装了 UDP，UDP 封装了 BOOTP。其实 DHCP 是 BOOTP 的增强版，但是如果你去抓包的话，很可能看到的名称还是 BOOTP 协议。
  
2. DHCP offer
  
  DHCP server找到一个可用的 IP 地址，然后发起广播（包含分配的IP地址），DHCP Server 为此客户保留为它提供的 IP 地址，从而不会为其他 DHCP 客户分配此 IP 地址。
  
3. DHCP request
  
  DHCP server可能有多个，DHCP Offer也可能有多个，新来的机器会选择其中一个DHCP Offer，一般是最先到达的那个，并且会向网络发送一个 DHCP Request 广播数据包，包中包含客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址等，并告诉所有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉其他 DHCP 服务器，谢谢你们的接纳，并请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。
  
4. DHCP acknowledge
  
  当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。
  

### IP 地址的收回和续租

DHCP分配的IP地址是有租期的。客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

## 预启动执行环境（PXE）

PXE 协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在 BIOS 里面。当计算机启动时，BIOS 把 PXE 客户端调入内存里面，就可以连接到服务端做一些操作了。

首先，PXE 客户端自己也需要有个 IP 地址。因为 PXE 的客户端启动起来，就可以发送一个 DHCP 的请求，让 DHCP Server 给它分配一个地址。

然后，PXE 客户端还需要知道 PXE 服务器的信息，需要在DHCP server中配置 next-server，指向 PXE 服务器的地址，另外要配置初始启动文件 filename。

### PXE 的工作过程

接下来我们来详细看一下 PXE 的工作过程。

1. 启动 PXE 客户端。
  
2. 通过 DHCP 协议告诉 DHCP Server，请求租一个 IP 地址，同时还有 PXE 服务器的地址、启动文件 pxelinux.0。
  
3. 通过执行pxelinux.0，PXE 客户端知道要去 PXE 服务器下载这个文件后，就可以初始化机器。于是便开始下载，下载的时候使用的是 TFTP 协议。所以 PXE 服务器上，往往还需要有一个 TFTP 服务器。PXE 客户端向 TFTP 服务器请求下载这个文件，TFTP 服务器将这个文件传给它，PXE 客户端收到这个文件后，就开始执行这个文件。
  
4. 这个文件会指示 PXE 客户端，向 TFTP 服务器请求计算机的配置信息 pxelinux.cfg。TFTP 服务器会给 PXE 客户端一个配置文件，里面会说内核在哪里、initramfs 在哪里。
  
5. PXE 客户端会请求这些文件。最后，启动 Linux 内核。
  

## 小结

1. DHCP 协议主要是用来给客户租用 IP 地址。
  
2. DHCP 协议能帮助构建PXE，能够安装操作系统，这个在云计算领域大有用处。
  

## 思考题

1. PXE 协议可以用来安装操作系统，但是如果每次重启都安装操作系统，就会很麻烦。你知道如何使得第一次安装操作系统，后面就正常启动吗？
  
  修改BIOS启动配置，设置为从本地磁盘启动
  

---

# ch05 从物理层到MAC层

## 第一层（物理层）

两台电脑构成一个最小的局域网，也即 LAN。

三台以上的电脑需要使用Hub，也就是集线器。这种设备有多个口，可以将宿舍里的多台电脑连接起来。但是，和交换机不同，集线器没有大脑，它完全在物理层工作。它会将自己收到的每一个字节，都复制到其他端口上去。这是第一层物理层联通的方案。

## 第二层（数据链路层）

Hub 采取的是广播的模式，如果每一台电脑发出的包，宿舍的每个电脑都能收到，那就麻烦了。这就需要解决几个问题：

1. 这个包是发给谁的？谁应该接收？
  
2. 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？
  
3. 如果发送的时候出现了错误，怎么办？
  

这几个问题，都是第二层（数据链路层），也即 MAC 层要解决的问题。MAC 的全称是 Medium Access Control，即媒体访问控制。控制什么呢？其实就是控制在往媒体上发数据的时候，谁先发、谁后发的问题。防止发生混乱。这解决的是第二个问题。这个问题中的规则，学名叫多路访问。

比如接下来这三种方式：

- 信道划分
  
- 轮流协议
  
- 随机接入协议
  

第一个问题：发给谁，谁接收？这里用到一个物理地址，叫作链路层地址。但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC 地址。解决第一个问题就牵扯到第二层的网络包格式。对于以太网，第二层的最开始，就是目标的 MAC 地址和源的 MAC 地址。

| 目标MAC | 源MAC | 类型  | 数据  | CRC |
| --- | --- | --- | --- | --- |
| 6 bytes | 6 bytes | 2 bytes | 46-1500 bytes | 4 bytes |

类型，大部分的类型是 IP 数据包，然后 IP 里面包含 TCP、UDP，以及 HTTP 等，这都是里层封装的事情。

- 有目标的MAC 地址
  
  有了这个目标 MAC 地址，数据包在链路上广播，MAC 的网卡才能发现，这个包是给它的。
  
  因为来的时候有源 MAC 地址，返回的时候，源 MAC 就变成了目标 MAC，再返给请求的机器。
  
  对于以太网，第二层的最后面是 CRC，也就是循环冗余检测。通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误，主要解决第三个问题。
  
- 没有目标的MAC 地址
  
  一个广播的网络里面接入了 N 台机器，我怎么知道每个 MAC 地址是谁呢？这就是 ARP 协议，也就是已知 IP 地址，求 MAC 地址的协议。通过发送一个广播包，谁是这个 IP的机器，谁就来回答，回答中包含自己的MAC地址。
  

> 为了避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存。当然机器会不断地上线下线，IP 也可能会变，所以 ARP 的 MAC 地址缓存过一段时间就会过期。

## 局域网

### hub组网的问题

当机器数目增多时，因为 Hub 是广播的，不管某个接口是否需要，所有的 Bit 都会被发送出去，然后让主机来判断是不是需要。因为每个口都只连接一台电脑，这台电脑又不怎么换 IP 和 MAC 地址，只要记住这台电脑的 MAC 地址，如果目标 MAC 地址不是这台电脑的，这个口就不用转发了。

需要有这样一种设备，能把 MAC 头拿下来，检查一下目标 MAC 地址，然后根据策略转发，这种设备就是交换机。

### 交换机的工作流程

1. 在转发表中查询目标MAC对应的口
  
2. 如果查询到目标MAC对应的口，就直接发送到对应的口
  
3. 查询不到则只能转发给其他所有的口
  
4. 记忆MAC与端口之间的对应关系，存储到转发表中
  

> 过了一段时间之后，就有了整个网络的一个结构了，这个时候，基本上不用广播了，全部可以准确转发。因为每个机器的 IP 地址会变，所在的口也会变，所以转发表是有一个过期时间的。

## 小结

1. MAC 层是用来解决多路访问的堵车问题的
  
2. ARP 是通过广播的方式来寻找目标 MAC 地址的，寻址完成后记住一段时间
  
3. 交换机是有 MAC 地址学习能力的，学完了就不需要广播。
  

## 思考题

1. 在二层中我们讲了 ARP 协议，即已知 IP 地址求 MAC；还有一种 RARP 协议，即已知 MAC 求 IP 的，你知道它可以用来干什么吗？
  
  RARP协议，已知MAC求IP。可以用来通过网卡指定IP。针对无盘系统，建立网卡和IP的映射，即可为该计算机分配IP。
  
2. 如果一个局域网里面有多个交换机，ARP 广播的模式会出现什么问题呢？
  
  ARP广播时，交换机会将一个端口收到的包转发到其它所有的端口上。
  比如数据包经过交换机A到达交换机B，交换机B又将包复制为多份广播出去。
  如果整个局域网存在一个环路，使得数据包又重新回到了最开始的交换机A，这个包又会被A再次复制多份广播出去。如此循环，数据包会不停得转发，而且越来越多，最终占满带宽，或者使解析协议的硬件过载，形成广播风暴。
  

---

# ch06 交换机与VLAN

## 拓扑结构是怎么形成的？

随着机器数量增多，一个交换机肯定不够用，需要多台交换机，交换机之间连接起来，就形成一个稍微复杂的拓扑结构。

与单交换机类似，在多交换机的网络中，交换机会学习不同局域网的拓扑关系。

## 如何解决常见的环路问题？

这还是一个包转来转去，每台机器都会发广播包，交换机转发也会复制广播包，当广播包越来越多的时候，按照上一节讲过一个共享道路的算法，也就是路会越来越堵，最后谁也别想走。所以，必须有一个方法解决环路的问题，怎么破除环路呢？

## STP 协议

在数据结构中，有一个叫做最小生成树。有环的我们常称为图。将图中的环破了，就生成了树。在计算机网络中，生成树的算法叫作 STP，全称 Spanning Tree Protocol。

STP中的概念

- Root Bridge，根交换机
  
- Designated Bridges，指定交换机
  
- Bridge Protocol Data Units （BPDU） ，网桥协议数据单元
  
- Priority Vector，优先级向量
  

## 如何解决广播问题和安全问题？

有如下两种分的方法

- 物理隔离
  
  每个子网使用单独的交换机，子网之间的通信需要路由器
  
- 虚拟隔离
  
  就是VLAN，或者叫虚拟局域网，使用 VLAN，一个交换机上会连属于多个局域网的机器，需要在原来的二层的头上加一个 TAG，里面有一个 VLAN ID，一共12bit
  
  交换机把二层的头取下来的时候，识别VLAN ID，只有相同 VLAN 的包，才会互相转发，不同 VLAN 的包，是看不到的
  
  交换机之间的连接，使用 Trunk 口，它可以转发属于任何 VLAN 的口。
  

## 小结

1. 当交换机的数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用 STP 协议，将有环路的图变成没有环路的树，从而解决环路问题。
  
2. 交换机数目多会面临隔离问题，可以通过 VLAN 形成虚拟局域网，从而解决广播问题和安全问题。
  

## 思考题

1. STP 协议能够很好地解决环路问题，但是也有它的缺点，你能举几个例子吗？
  
  - 网络拓扑发生变化时，收敛效率低
2. 在一个比较大的网络中，如果两台机器不通，你知道应该用什么方式调试吗
  
  ping、traceroute